#!/bin/bash

export WHRUNKIT_ORIGCOMMAND="$0"
source "${BASH_SOURCE%/*}/../libexec/functions.sh"

if [ "${1:0:1}" == "@" ]; then #WebHare server directed command
  export WHRUNKIT_TARGETSERVER="${1:1}"
  shift

  loadtargetsettings

  CMD="$1"
  shift

  if [ ! -d "$WHRUNKIT_TARGETDIR" ]; then
    echo "No such server $WHRUNKIT_TARGETSERVER (missing directory $WHRUNKIT_TARGETDIR)" 1>&2
    exit 1
  fi

  if [ ! -f "$WHRUNKIT_ROOT/libexec/atserver/$CMD.sh" ]; then
    echo "Unknown at-server command '$CMD' - try 'runkit help' ?"
    exit 1
  fi

  export WHRUNKIT_WHCOMMAND=""
  if [ -n "$WEBHARE_DIR" ] && [ -x "$WEBHARE_DIR/bin/wh" ]; then
    WHRUNKIT_WHCOMMAND="$WEBHARE_DIR/bin/wh"
  elif [ -x ~/projects/webhare/whtree/bin/wh ]; then
    WHRUNKIT_WHCOMMAND="$HOME/projects/webhare/whtree/bin/wh"
  else
    echo "Don't know where to find your bin/wh" 1>&2
    exit 1
  fi

  [ -n "$WEBHARE_BASEPORT" ] || die "Baseport ($WHRUNKIT_TARGETDIR/baseport) not set"
  [ -n "$WEBHARE_DATAROOT" ] || die "Dataroot ($WHRUNKIT_TARGETDIR/dataroot) not set and $WHRUNKIT_TARGETDIR/whdata not present"
  [ -f "$WHRUNKIT_TARGETDIR/opensearch-bindhost" ] && export WEBHARE_OPENSEARCH_BINDHOST="$(cat "$WHRUNKIT_TARGETDIR/opensearch-bindhost")"

  if [ "$WEBHARE_BASEPORT" != "13679" ] && [ ! -f "$WHRUNKIT_TARGETDIR/allowinstallationinfo" ]; then # NOT  the default
    export WEBHARE_NOINSTALLATIONINFO=1 # perhaps not for the default install?
  fi
  if [ "$WEBHARE_BASEPORT" != "13679" ] && [ ! -f "$WHRUNKIT_TARGETDIR/allowpolicy" ]; then # NOT  the default
    export WEBHARE_MODULEPATHS=  # avoid webharecue/policy from interfering with us - but it should actually watch subinstallations but not eg. restores ?
  fi
  [ -x "$WHRUNKIT_TARGETDIR/startup.sh" ] && export WEBHARE_POSTSTARTSCRIPT="$WHRUNKIT_TARGETDIR/startup.sh"

  # settings.sh overrides BASEPORT and DATAROOT and interferes with us. WebHare should re-evaluate whether wh restore generated settings.sh is really needed
  [ -f "$WEBHARE_DATAROOT/settings.sh" ] && rm "$WEBHARE_DATAROOT/settings.sh"

  if [ -f "$WHRUNKIT_TARGETDIR/restore.archive" ]; then
    export WEBHARE_ISRESTORED="Restored $(cat $WHRUNKIT_TARGETDIR/restore.archive) from $(cat $WHRUNKIT_TARGETDIR/restore.borgrepo)"
  fi

  [ -x "$WHRUNKIT_TARGETDIR/environment.sh" ] && source "$WHRUNKIT_TARGETDIR/environment.sh"

  # TODO only if not the default:
  source "$WHRUNKIT_ROOT/libexec/atserver/$CMD.sh" "$@"
  exit 255
fi

# runkit directed command
CMD="$1"
shift

if [ ! -f "$WHRUNKIT_ROOT/libexec/atrunkit/$CMD.sh" ]; then
  echo "Unknown at-runkit command '$CMD' - try 'runkit help' ?"
  exit 1
fi

source "$WHRUNKIT_ROOT/libexec/atrunkit/$CMD.sh" "$@"
exit 255
